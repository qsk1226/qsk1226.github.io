<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    慢查询 - 大爷来玩儿啊~
    
    </title>
    <link rel="shortcut icon" href="media/15865826719099/icon.png" type="image/png" />

    
    
    <link href="atom.xml" rel="alternate" title="大爷来玩儿啊~" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/style.min.css">
    <link rel="stylesheet" href="asset/css/doc.css">
    <script src="asset/app.js"></script>
</head>
  <body>
    <section class="hero">
      <div class="hero-head">
          <nav class="navbar" role="navigation" aria-label="main navigation">
              <div class="container">
              <div class="navbar-brand">
                
                <a target="_self" class="navbar-item " href="index.html">博客</a>
                
                <a target="_self" class="navbar-item " href="archives.html">归档</a>
                

                <a role="button" id="navbarSNSRssSwitchBtn" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarSNSRssButtons">
                  <span aria-hidden="true"></span>
                  <span aria-hidden="true"></span>
                  <span aria-hidden="true"></span>
                </a>
              </div>
            
              <div id="navbarSNSRssButtons" class="navbar-menu">
                <div class="navbar-start">
                  
                </div>
            
                <div class="navbar-end">
                  <div class="navbar-item">
                    <!--buttons start-->
                    <div class="buttons">
                      
                        
                        
                        
                        
                      
                      <a href="atom.xml" target="_blank" title="RSS">
                          <span class="icon is-large has-text-black-bis">
                              <svg class="svg-inline--fa fa-rss fa-w-14 fa-lg" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                          </span>
                      </a>
                    </div>
                    <!--buttons end-->

                  </div>
                </div>
                </div>
              </div>
            </nav>
      </div>

 <div class="hero-body ct-body"></div>
      
    </section>
    <section class="ct-body">
      <div class="container">
          <div class="columns is-variable bd-klmn-columns is-4 is-centered">
              <div class="column is-four-fifths">
                  <div class="post-body single-content">
                    
                    <h1 class="title">
                            慢查询   
                      </h1>
                     
                    
                      <div class="media">
                            
                            <figure class="media-left">
                              <p class="image is-48x48">
                                
                                  <img class="is-rounded" src="media/15865826719099/avatar.png">
                                
                              </p>
                            </figure>
                            
                            <div class="media-content">
                              <div class="content">
                                <p>
                                 <span class="date">2020/08/13</span>
                                  <span class="tran-posted-in">posted in</span>&nbsp; 
                                  
                                      <span class="posted-in"><a href='mysql.html'>mysql</a></span>
                                         
                                  

                                   
                                      
                                  <br />
                                  <span class="tran-tags">Tags:</span>&nbsp;
                                     

                                </p>
                              </div>
                            </div>
                         
                    </div>
                </div>
                  <article class="markdown-body single-content">
                    <p>慢查询日志，顾名思义，就是查询慢的日志，是指 mysql 记录所有执行超过 long_query_time 参数设定的时间阈值的 SQL 语句的日志。该日志能为 SQL 语句的优化带来很好的帮助。默 认情况下，慢查询日志是关闭的，要使用慢查询日志功能，首先要开启慢查询日志功能。</p>
<h2><a id="%E6%85%A2%E6%9F%A5%E8%AF%A2%E9%85%8D%E7%BD%AE" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>慢查询配置</h2>
<ul>
<li>slow_query_log 启动停止技术慢查询日志</li>
<li>slow_query_log_file 指定慢查询日志得存储路径及文件(默认和数据文件放一起)</li>
<li>long_query_time 指定记录慢查询日志 SQL 执行时间得阈值(单位:秒，默认 10 秒)</li>
<li>log_queries_not_using_indexes 是否记录未使用索引的 SQL</li>
<li>log_output 日志存放的地方【TABLE】【FILE】【FILE,TABLE】</li>
</ul>
<p>配置了慢查询后，它会记录符合条件的 SQL 包括:</p>
<ul>
<li>查询语句</li>
<li>数据修改语句</li>
<li>已经回滚得SQL</li>
</ul>
<p>通过下面命令查看下上面的配置</p>
<pre><code class="language-sql">show VARIABLES like '%slow_query_log%'
show VARIABLES like '%long_query_time%'
show VARIABLES like '%log_queries_not_using_indexes%'


set global long_query_time=0; ---默认 10 秒，这里为了演示方便设置为 0
set GLOBAL slow_query_log = 1; --开启慢查询日志
set global log_output='FILE,TABLE' --项目开发中日志只能记录在日志文件中，不能记表中

</code></pre>
<p>##慢查询解读</p>
<p>从慢查询日志里面摘选一条慢查询日志，数据组成如下</p>
<pre><code class="language-plain_text"># User@Host: root[root] @ localhost [127.0.0.1]  Id:     8
# Query_time: 0.007054  
# Lock_time: 0.000141 
# Rows_sent: 14  
# Rows_examined: 14
SET timestamp=1602090433;
SELECT * FROM race;
</code></pre>
<p>第一行:用户名 、用户的 IP 信息、线程 ID 号<br />
第二行:执行花费的时间【单位:毫秒】<br />
第三行:执行获得锁的时间<br />
第四行:获得的结果行数<br />
第五行:扫描的数据行数<br />
第六行:这 SQL 执行的具体时间<br />
第七行:具体的 SQL 语句</p>
<h3><a id="%E6%85%A2%E6%9F%A5%E8%AF%A2%E5%88%86%E6%9E%90" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>慢查询分析</h3>
<p>慢查询的日志记录非常多，要从里面找寻一条查询慢的日志并不是很容易的事情，一般来说都需要一些工具辅助才能快速定位到需要优化的 SQL 语句，下面介绍个慢查询辅助工具</p>
<h4><a id="mysqldumpslow" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mysqldumpslow</h4>
<p>常用的慢查询日志分析工具，汇总除查询条件外其他完全相同的 SQL，并将分析结果按照参 数中所指定的顺序输出。</p>
<p>语法:<br />
mysqldumpslow -s r -t 10 slow-mysql.log<br />
-s order (c,t,l,r,at,al,ar)<br />
c:总次数<br />
t:总时间<br />
l:锁的时间<br />
r:总数据行<br />
at,al,ar :t,l,r 平均数 【例如:at = 总时间/总次数】<br />
-t top 指定取前面几天作为结果输出</p>
<p>执行 mysqldumpslow -s t -t 10 /usr/local/var/mysql/mysql-slow.log</p>
<pre><code class="language-plain_text">Reading mysql slow query log from /usr/local/var/mysql/qinshengke-slow.log
Count: 1  Time=0.01s (0s)  Lock=0.00s (0s)  Rows=14.0 (14), root[root]@localhost
  SELECT * FROM race

Count: 1  Time=0.01s (0s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@localhost
  SELECT ROUTINE_SCHEMA as function_schema,ROUTINE_NAME as function_name,ROUTINE_DEFINITION as create_statement,ROUTINE_TYPE as function_type FROM information_schema.routines where ROUTINE_SCHEMA='S'

Count: 1  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=583.0 (583), root[root]@localhost
  SHOW VARIABLES

Count: 1  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@localhost
  SELECT table_name as table_name,column_name as column_name,column_type as column_type FROM information_schema.columns WHERE table_schema='S'AND data_type='S'

Count: 1  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=1.0 (1), root[root]@localhost
  SELECT column_name as column_name FROM information_schema.statistics WHERE table_schema = 'S' AND table_name = 'S' AND index_name = 'S' ORDER BY seq_in_index ASC

Count: 1  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=8.0 (8), root[root]@localhost
  show full tables from `wow`

Count: 10  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=1.0 (10), root[root]@localhost
  SELECT N

Count: 1  Time=0.00s (0s)  Lock=0.00s (0s)  Rows=8.0 (8), root[root]@localhost
  show databases
</code></pre>

                  </article>
                  <div class="comments-wrap">
                    <div class="share-comments">
                      

                      

                      
                    </div>
                  </div><!-- end comments wrap -->
              </div>
            </div><!-- end columns -->
      </div><!-- end container -->
    </section>



    <footer class="footer">
        <div class="content has-text-centered">
          <p>
              Copyright &copy; 2019
              Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
              Theme used <a target="_blank" href="https://bulma.io/">Bulma CSS</a>.
          </p>
        </div>
      </footer>



  













<script src="asset/prism.js"></script>



  
    




  </body>
</html>
