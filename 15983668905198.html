<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    一致性算法 - 大爷来玩儿啊~
    
    </title>
    <link rel="shortcut icon" href="media/15865826719099/icon.png" type="image/png" />

    
    
    <link href="atom.xml" rel="alternate" title="大爷来玩儿啊~" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/style.min.css">
    <link rel="stylesheet" href="asset/css/doc.css">
    <script src="asset/app.js"></script>
</head>
  <body>
    <section class="hero">
      <div class="hero-head">
          <nav class="navbar" role="navigation" aria-label="main navigation">
              <div class="container">
              <div class="navbar-brand">
                
                <a target="_self" class="navbar-item " href="index.html">博客</a>
                
                <a target="_self" class="navbar-item " href="archives.html">归档</a>
                

                <a role="button" id="navbarSNSRssSwitchBtn" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarSNSRssButtons">
                  <span aria-hidden="true"></span>
                  <span aria-hidden="true"></span>
                  <span aria-hidden="true"></span>
                </a>
              </div>
            
              <div id="navbarSNSRssButtons" class="navbar-menu">
                <div class="navbar-start">
                  
                </div>
            
                <div class="navbar-end">
                  <div class="navbar-item">
                    <!--buttons start-->
                    <div class="buttons">
                      
                        
                        
                        
                        
                      
                      <a href="atom.xml" target="_blank" title="RSS">
                          <span class="icon is-large has-text-black-bis">
                              <svg class="svg-inline--fa fa-rss fa-w-14 fa-lg" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                          </span>
                      </a>
                    </div>
                    <!--buttons end-->

                  </div>
                </div>
                </div>
              </div>
            </nav>
      </div>

 <div class="hero-body ct-body"></div>
      
    </section>
    <section class="ct-body">
      <div class="container">
          <div class="columns is-variable bd-klmn-columns is-4 is-centered">
              <div class="column is-four-fifths">
                  <div class="post-body single-content">
                    
                    <h1 class="title">
                            一致性算法   
                      </h1>
                     
                    
                      <div class="media">
                            
                            <figure class="media-left">
                              <p class="image is-48x48">
                                
                                  <img class="is-rounded" src="media/15865826719099/avatar.png">
                                
                              </p>
                            </figure>
                            
                            <div class="media-content">
                              <div class="content">
                                <p>
                                 <span class="date">2020/08/25</span>
                                  <span class="tran-posted-in">posted in</span>&nbsp; 
                                  
                                      <span class="posted-in"><a href='%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html'>解决方案</a></span>
                                         
                                  

                                   
                                      
                                  <br />
                                  <span class="tran-tags">Tags:</span>&nbsp;
                                     

                                </p>
                              </div>
                            </div>
                         
                    </div>
                </div>
                  <article class="markdown-body single-content">
                    <h2><a id="1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%80%E8%87%B4%E6%80%A7" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>1、什么是一致性</h2>
<p>CAP理论，对于一个分布式系统，不能同时满足一下三点</p>
<ul>
<li>一致性（Consistency）</li>
<li>可用性（Availability）</li>
<li>分区容错性（Partition Tolerance）</li>
</ul>
<p><figure><img src="media/15983668905198/16008790045537.jpg" alt="" /></figure></p>
<h2><a id="2%E3%80%81%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%9E%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>2、一致性模型</h2>
<ul>
<li>弱一致性
<ul>
<li>最终一致性
<ul>
<li>DNS（Domain Name System）</li>
<li>Gossip（Cassandra的通信协议）</li>
</ul>
</li>
</ul>
</li>
<li>强一致性
<ul>
<li>同步</li>
<li>Paxos</li>
<li>Raft（multi-paxos)</li>
<li>ZAB（multi-paxos）</li>
</ul>
</li>
</ul>
<p>数据不能存在单点上<br />
分布式系统对 fault tolorence 的一般解决方案是 state machine replication</p>
<p>state machine replication的公式（consensus）算法</p>
<p>paxos其实是一个共识算法。系统的最终一致性，不仅需要达成共识，还会取决于client 的行为</p>
<h2><a id="%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>强一致性算法---主从同步</h2>
<ul>
<li>master接受写请求</li>
<li>master复制日志到slave</li>
<li>master等待，知道所有从库返回成功</li>
</ul>
<p>不足之处： 一个节点失败，master阻塞，导致整个集群不可用，保证了一致性，但是可用性非常低</p>
<h2><a id="%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95%E5%A4%9A%E6%95%B0%E6%B4%BE" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>强一致性算法---多数派</h2>
<p>基本思路：每次写都保证写入大于N/2个节点，每次度保证大于N/2个节点中读</p>
<p>不足之处： 并发环境下，无法保证执行指令的顺序，系统正确性不能得到保证，这种算法顺序非常重要</p>
<h2><a id="%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95paxos" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>强一致性算法---Paxos</h2>
<h3><a id="%E7%94%B1%E6%9D%A5" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>由来</h3>
<p>Lesile Lamport，Latex的发明者。为描述Paxos算法，Paxos的坐着 lamport 虚拟了一个叫做Paxos的希腊城邦，这个岛按照议会民主制的政治模型制定法律，但是没有人愿意将自己的全部时间和精力放在这种事情上。所以无论是议员或者递纸条的服务员都不能承诺别人需要时一定会出现，也无法承诺批准决议或者传递消息的时间。</p>
<p>Paxos</p>
<ul>
<li>Basic paxos</li>
<li>multi paxos</li>
<li>fast paxos</li>
</ul>
<h3><a id="basic-paxos%E8%A7%92%E8%89%B2%E4%BB%8B%E7%BB%8D%EF%BC%9A" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>basic Paxos 角色介绍：</h3>
<ul>
<li>client：系统外部角色，请求发起者，比如民众，不参与投票的人</li>
<li>Propser： 接受client请求，向集群提出提议（propose）。并在冲突发生时，起到冲突调节的作用，像议员，替民众提出议案</li>
<li>Accepetor（voter）： 提议投票和接受者，只有在形成法定人数（Quorum，一般即为majority多数派）时，提议才会最终被接受，像国会</li>
<li>Learner： 提议接受者，backup，备份，对集群一致性没有影响，想记录员</li>
</ul>
<h3><a id="basic-paxos%E9%98%B6%E6%AE%B5%E6%AD%A5%E9%AA%A4" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>basic Paxos 阶段步骤</h3>
<ul>
<li>Phase 1a： prepare<br />
proposer提出一个提案，编号为N，此N大于这个proposer之前提出提案编号。请求acceptors的quorum接受</li>
<li>Phase 1b： Promise<br />
如果N大于此acceptor之前接受的任何提案编号则接受，否则拒绝</li>
<li>phase 2a： accept<br />
如果达到了多数派，proposer会发出accept请求，此请求包含提案编号N，以及提案内容</li>
<li>phase 2b：accepted</li>
<li>如果此acceptor在此期间没有收到任何编号大于N的提案，则接受此提案内容，否则忽略</li>
</ul>
<p>基本流程：<br />
<figure><img src="media/15983668905198/16012212157714.jpg" alt="" /></figure></p>
<p>部分节点失败，但达到了 quorums，3个人里面的2人接受提案</p>
<p><figure><img src="media/15983668905198/16012214247282.jpg" alt="" /></figure></p>
<p>proposer失败场景</p>
<p><figure><img src="media/15983668905198/16012215680680.jpg" alt="" /></figure></p>
<p>basic paxos 潜在问题： 活锁（liveness）或dueling，难实现、效率低（两轮rpc）<br />
<figure><img src="media/15983668905198/16012217390496.jpg" alt="" /></figure></p>
<p>使用rundom的实际时间来让请求休息一下</p>
<h2><a id="multi-paxos" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>multi Paxos:</h2>
<p>加入新概念 Leader : 唯一的 propser 所有请求都需要经过leader</p>
<p><figure><img src="media/15983668905198/16012224581326.jpg" alt="" /></figure></p>
<p>上面一轮是 要竞选出leader，下面一轮请求过来之后，只需要和选出来的leader交互就可以了。</p>
<p>进一步简化，减少角色<br />
<figure><img src="media/15983668905198/16012226175886.jpg" alt="" /></figure></p>
<h2><a id="%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95raft" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>强一致性算法---raft</h2>
<ul>
<li>Raft
<ul>
<li>划分成三个子问题<br />
-领袖选举（leader election）
<ul>
<li>日志复制（log replication）</li>
<li>safety</li>
</ul>
</li>
<li>重定义角色
<ul>
<li>leader</li>
<li>follower</li>
<li>candidate</li>
</ul>
</li>
<li>原理动画解释： <a href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/</a></li>
</ul>
</li>
</ul>

                  </article>
                  <div class="comments-wrap">
                    <div class="share-comments">
                      

                      

                      
                    </div>
                  </div><!-- end comments wrap -->
              </div>
            </div><!-- end columns -->
      </div><!-- end container -->
    </section>



    <footer class="footer">
        <div class="content has-text-centered">
          <p>
              Copyright &copy; 2019
              Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
              Theme used <a target="_blank" href="https://bulma.io/">Bulma CSS</a>.
          </p>
        </div>
      </footer>



  















  
    




  </body>
</html>
